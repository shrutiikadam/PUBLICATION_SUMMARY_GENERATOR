<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google Scholar Author Lookup</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f9;
        color: #333;
        line-height: 1.6;
      }
      h1 {
        text-align: center;
        color: #333;
      }
      .container {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .input-group {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
      }
      .input-group input {
        width: 70%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-right: 10px;
        font-size: 16px;
      }
      .input-group button {
        padding: 10px 20px;
        border: none;
        background: #007bff;
        color: white;
        font-size: 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
      }
      .input-group button:hover {
        background: #0056b3;
      }
      #output {
        margin-top: 20px;
      }
      .card {
        background: #f9f9f9;
        padding: 15px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .thumbnail {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 50%;
        margin-bottom: 10px;
      }
      .btns {
        margin-top: 10px;
      }
      .btns button {
        margin-right: 10px;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background: #28a745;
        color: white;
        transition: background 0.3s;
      }
      .btns button:hover {
        background: #218838;
      }
      #citationChartContainer {
        display: none; /* Initially hidden */
        margin-top: 30px;
      }
      #papersContainer {
        padding: 20px;
      }

      .card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        background-color: #fff;
      }

      .card h3 {
        margin-top: 0;
        font-size: 1.25rem;
        color: #333;
      }

      .card p {
        margin: 8px 0;
        color: #555;
      }

      /* .card a {
        display: inline-block;
        text-decoration: none;
        padding: 8px 12px;
        background-color: #007bff;
        color: #fff;
        border-radius: 4px;
        font-size: 0.875rem;
        transition: background-color 0.3s ease;
      } */

      /* .card a:hover {
        background-color: #0056b3;
      } */
      .card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 16px;
        margin: 16px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-width: 400px;
        font-family: Arial, sans-serif;
      }

      .card img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 16px;
      }

      .card h3 {
        font-size: 1.2em;
        margin-bottom: 8px;
      }

      .card p {
        margin: 8px 0;
      }

      .card ul {
        list-style: disc;
        padding-left: 20px;
        margin-top: 8px;
      }

      .card a {
        color: #007bff;
        text-decoration: none;
      }

      .card a:hover {
        text-decoration: underline;
      }

      .card button {
        margin: 8px 4px;
        padding: 8px 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .card button:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <h1>Author Lookup</h1>
      <div class="input-group">
        <input
          type="text"
          id="authorInput"
          placeholder="Enter an author's name"
        />
        <button id="fetchButton">Fetch</button>
      </div>
      <div id="output"></div>
      <div id="papersContainer" style="padding: 20px"></div>

      <div id="citationChartContainer">
        <canvas id="citationChart" width="400" height="200"></canvas>
      </div>
    </div>
    <div
      id="chatbot-btn"
      style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #00aaff;
        color: white;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        font-size: 30px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      "
      onclick="toggleChatbot()"
    >
      ðŸ’¬
    </div>

    <!-- Chatbot window (hidden by default) -->
    <div
      id="chatbot-window"
      style="
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 300px;
        height: 400px;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        display: none;
        flex-direction: column;
        z-index: 1000;
      "
    >
      <div
        class="chatbot-header"
        style="
          background-color: #00aaff;
          color: white;
          padding: 10px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-top-left-radius: 8px;
          border-top-right-radius: 8px;
        "
      >
        <span style="font-weight: bold">Chatbot</span>
        <button
          class="close-btn"
          style="
            background: transparent;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
          "
          onclick="toggleChatbot()"
        >
          X
        </button>
      </div>
      <div
        id="chatbot-messages"
        style="
          flex: 1;
          padding: 10px;
          overflow-y: auto;
          background-color: #f9f9f9;
          border-bottom: 1px solid #ddd;
        "
      ></div>
      <input
        type="text"
        id="user-input"
        class="user-input"
        placeholder="Type a message..."
        style="
          padding: 10px;
          border: 1px solid #ddd;
          border-top: none;
          border-bottom-left-radius: 8px;
          border-bottom-right-radius: 8px;
          width: 100%;
          box-sizing: border-box;
        "
        onkeydown="sendMessage(event)"
      />
    </div>

    <script>
      function toggleChatbot() {
        const chatbotWindow = document.getElementById("chatbot-window");
        chatbotWindow.style.display =
          chatbotWindow.style.display === "none" ? "flex" : "none";
      }

      // Function to send message
      function sendMessage(event) {
        const inputField = document.getElementById("user-input");
        const messageContainer = document.getElementById("chatbot-messages");

        if (event.key === "Enter" && inputField.value.trim() !== "") {
          const userMessage = inputField.value;
          inputField.value = "";
          const screen = document.getElementsByClassName("card");
          const screenContent = screen.innerHTML; // Or use screen.textContent for plain text

          const combinedMessage = `${userMessage}\n${screenContent}`; // Combine userMessage and screen content
          console.log(combinedMessage);

          // Display user message
          const userMessageElem = document.createElement("div");
          userMessageElem.classList.add("message", "user-message");
          userMessageElem.textContent = userMessage;
          userMessageElem.style.backgroundColor = "#00aaff";
          userMessageElem.style.color = "white";
          userMessageElem.style.padding = "10px";
          userMessageElem.style.borderRadius = "10px";
          userMessageElem.style.marginBottom = "10px";
          userMessageElem.style.maxWidth = "80%";
          userMessageElem.style.alignSelf = "flex-end";
          messageContainer.appendChild(userMessageElem);

          // Scroll to the bottom of the messages container
          messageContainer.scrollTop = messageContainer.scrollHeight;

          const payload = {
            model: "llama3.2",
            prompt: combinedMessage,
          };

          // Send the JSON request
          fetch("/generate", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          })
            .then((response) => response.json())
            .then((data) => {
              const botResponse = data.response;
              // Simulate a bot reply after a delay
              setTimeout(() => {
                const botMessageElem = document.createElement("div");
                botMessageElem.classList.add("message", "bot-message");
                botMessageElem.textContent = `${botResponse}`;
                botMessageElem.style.backgroundColor = "#e4e4e4";
                botMessageElem.style.color = "#333";
                botMessageElem.style.padding = "10px";
                botMessageElem.style.borderRadius = "10px";
                botMessageElem.style.marginBottom = "10px";
                botMessageElem.style.maxWidth = "80%";
                botMessageElem.style.alignSelf = "flex-start";
                messageContainer.appendChild(botMessageElem);

                // Scroll to the bottom again after bot message
                messageContainer.scrollTop = messageContainer.scrollHeight;
              }, 1000);
            })
            .catch((error) => {
              console.error("Error:", error);
              displayBotResponse("Sorry, I couldn't process your request.");
            });
        }
      }
      let citationChartInstance = null; // Global variable to store the chart instance
      document.getElementById("fetchButton").addEventListener("click", () => {
        const authorName = document.getElementById("authorInput").value.trim();
        const output = document.getElementById("output");
        const papersContainer = document.getElementById("papersContainer");
        const citationChartContainer = document.getElementById(
          "citationChartContainer"
        );
        const citationChart = document.getElementById("citationChart");
        // Clear the output and papers containe

        const chartContainer = document.getElementById(
          "citationChartContainer"
        );

        output.innerHTML = "";
        papersContainer.innerHTML = "";
        if (citationChartInstance) {
          citationChartInstance.destroy();
        }
        chartContainer.style.display = "none"; // Hide chart initially

        if (!authorName) {
          output.textContent = "Please enter an author's name.";
          return;
        }

        fetch(`/fetch_authors?author=${encodeURIComponent(authorName)}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              output.textContent = `Error: ${data.error}`;
              return;
            }

            const authors = data; // Assuming 'authors' contains the list of authors
            //  console.log(authors);

            if (Array.isArray(authors)) {
              authors.forEach((author) => {
                // Fetch citation data for each author
                //console.log(author.author_id);
                fetch(
                  `/citations?author_id=${encodeURIComponent(author.author_id)}`
                )
                  .then((response) => response.json())
                  .then((citationData) => {
                    console.log(citationData);
                    const authorName = author.name || "Unknown Author";
                    const authorThumbnail =
                      citationData.author.thumbnail || "default-thumbnail.png";

                    // Create a card for the author
                    const card = document.createElement("div");
                    card.className = "card";
                    card.onclick = function () {
                      fetch_citations(citationData);
                    };

                    // Create the thumbnail element
                    const img = document.createElement("img");
                    img.src = authorThumbnail;
                    img.alt = authorName;
                    img.className = "thumbnail";

                    // Create the name element
                    const nameElement = document.createElement("h3");
                    nameElement.textContent = authorName;

                    // Create the citations display
                    const citationElement = document.createElement("p");
                    citationElement.textContent = `Citations: ${
                      author.cited_by || "N/A"
                    }`;

                    // Append elements to the card
                    card.appendChild(img);
                    card.appendChild(nameElement);
                    card.appendChild(citationElement);

                    // Append the card to the output
                    output.appendChild(card);
                  })
                  .catch((error) => {
                    output.textContent = `Error fetching citations: ${error}`;
                  });
              });
            } else {
              output.textContent = "No author data found.";
            }
          })
          .catch((error) => {
            output.textContent = `Error: ${error}`;
          });
      });

      function fetch_citations(data) {
        console.log(data);
        const author = data.author;
        const output = document.getElementById("output");
        output.innerHTML = "";

        let labels = [];
        let citationData = [];

        const card = document.createElement("div");
        card.className = "card";

        // Check if cited_by and table exist
        if (data.cited_by && data.cited_by.graph && data.cited_by.table) {
          labels = data.cited_by.graph.map((entry) => entry.year);
          citationData = data.cited_by.graph.map((entry) => entry.citations);
          //console.log(citationData);
        }

        // Generate interests list
        const interests = author.interests?.length
          ? author.interests
              .map((interest) => `<li>${interest.title}</li>`)
              .join("")
          : "<li>None listed</li>";

        card.innerHTML = `
      <img src="${author.thumbnail || ""}" alt="${author.name || "Author"}" />
      <h3>${author.name || "Unknown Author"}</h3>
      <p><strong>Affiliations:</strong> ${
        author.affiliations || "Not Available"
      }</p>
      <p><strong>Total Citations:</strong> ${
        data.cited_by?.table[0]?.citations?.all || 0
      }</p>
      <p><strong>H-Index:</strong> ${
        data.cited_by?.table[1]?.h_index?.all || 0
      }</p>
      <p><strong>I-10 Index:</strong> ${
        data.cited_by?.table[2]?.i10_index?.all || 0
      }</p>
      <p><strong>Interests:</strong></p>
      <ul>${interests}</ul>
      <p>
        <strong>Link:</strong> 
        <a href="${
          data.search_metadata.google_scholar_author_url
        }" target="_blank">
          ${data.search_metadata.google_scholar_author_url}
        </a>
      </p>
      <div>
          <button onclick='showPapers(${JSON.stringify(
            data.articles
          )})'>Papers</button>
          <button onclick='renderChart(${JSON.stringify(
            labels
          )}, ${JSON.stringify(citationData)})'>Citation Graph</button>
      </div>
`;

        output.appendChild(card);
      }

      function showPapers(articles) {
        const papersContainer = document.getElementById("papersContainer");
        const citationChartContainer = document.getElementById(
          "citationChartContainer"
        );

        if (citationChartInstance) {
          citationChartInstance.destroy();
        }

        if (!papersContainer) {
          console.error("Error: papersContainer element not found.");
          return;
        }

        papersContainer.innerHTML = ""; // Clear existing content

        if (!articles || articles.length === 0) {
          papersContainer.innerHTML = "<p>No papers available.</p>";
          return;
        }

        // Add a header for the papers section
        const header = document.createElement("h2");
        header.innerText = "Papers by Author";
        papersContainer.appendChild(header);

        // Create a grid layout for paper cards
        const grid = document.createElement("div");
        grid.style.display = "grid";
        grid.style.gridTemplateColumns = "repeat(auto-fit, minmax(300px, 1fr))";
        grid.style.gap = "16px";

        articles.forEach((article) => {
          const card = document.createElement("div");
          card.style.border = "1px solid #ddd";
          card.style.borderRadius = "8px";
          card.style.padding = "16px";
          card.style.boxShadow = "0 4px 6px rgba(0, 0, 0, 0.1)";
          card.style.backgroundColor = "#fff";

          card.innerHTML = `
            <h3 style="margin-top: 0; font-size: 1.25rem; color: #333;">${
              article.title
            }</h3>
            <p style="margin: 8px 0; color: #555;">Authors: ${
              article.authors || "Unknown"
            }</p>
            <p>Publication: ${article.publication}</p>
            <p>Year: ${article.year}</p>
            <a href="${article.link}" target="_blank" style="
                display: inline-block;
                text-decoration: none;
                padding: 8px 12px;
                background-color: #007BFF;
                color: #fff;
                border-radius: 4px;
                font-size: 0.875rem;
                transition: background-color 0.3s ease;
            " 
            onmouseover="this.style.backgroundColor='#0056b3';" 
            onmouseout="this.style.backgroundColor='#007BFF';"
            >Read Paper</a>
        `;

          grid.appendChild(card);
        });

        papersContainer.appendChild(grid);
      }

      function renderChart(labels, data) {
        const ctx = document.getElementById("citationChart").getContext("2d");
        const chartContainer = document.getElementById(
          "citationChartContainer"
        );
        const papers = document.getElementById("papersContainer");
        papers.innerHTML = "";
        chartContainer.style.display = "block"; // Make chart visible
        if (citationChartInstance) {
          citationChartInstance.destroy();
        }
        citationChartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Citations Per Year",
                data: data,
                backgroundColor: "rgba(75, 192, 192, 0.2)",
                borderColor: "rgba(75, 192, 192, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Number of Citations",
                },
              },
              x: {
                title: {
                  display: true,
                  text: "Year",
                },
              },
            },
          },
        });
      }

      window.addEventListener("scroll", () => {
        const { scrollTop, scrollHeight, clientHeight } =
          document.documentElement;

        // Log the current scroll values
        console.log(scrollTop, scrollHeight, clientHeight);

        // Check if the user has reached the end of the page
        if (scrollTop + clientHeight >= scrollHeight) {
          fetch(
            `/next_page?author=${encodeURIComponent(
              author.name
            )}&author_after=${encodeURIComponent(
              author.pagination.next_page_token
            )}`
          )
            .then((response) => response.json())
            .then((citationData) => {
              console.log(citationData);
            });
        }
      });
    </script>
  </body>
</html>
